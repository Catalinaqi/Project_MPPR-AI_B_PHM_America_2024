version: "1.0"
stage2_understanding:
  objective: "Cargar CSV, describir estructura, evaluar calidad y hacer EDA. No modifica datos; solo genera reportes/artefactos."

  dataset_input:
    source_type: "csv"
    path: "${dataset_path}"           # lo inyecta el notebook o dataset_config
    csv_params:
      sep: ","
      encoding: "utf-8"
      decimal: "."
      low_memory: true

    # Para datasets grandes: por defecto trabaja sobre una muestra para EDA/calidad
    read_strategy:
      mode: "sample"                  # full | sample | chunked
      sample_rows: 200000             # si mode=sample
      sample_frac: null               # alternativa: 0.05 (5%), usa uno u otro
      random_state: 42
      chunksize: 200000               # si mode=chunked (para profiling parcial)

  output_policy:
    save_all_as_png: true
    figures_dir: "figures/stage2"
    tables_png_dir: "tables_png/stage2"
    overwrite: true
    dpi: 150

  steps:

    # 2.1 Collezionare i dati iniziali (Data acquisition) — SOLO CSV en tu escenario
    step_2_1_data_acquisition:
      enabled: true
      technique: "data_acquisition"
      methods:
        load_csv:
          enabled: true
          params:
            infer_datetime: true      # intenta detectar columnas datetime
            parse_dates: []           # opcional: ["date_col"] si ya lo sabes

    # 2.2 Descrivere i dati (Describe data)
    step_2_2_describe_data:
      enabled: true
      techniques:

        descriptive_statistics:
          enabled: true
          methods:
            describe:
              enabled: true
              params:
                include: "all"        # pandas describe(include="all")
                numeric_only: false
            min_max_mean_std:
              enabled: true
              params:
                numeric_only: true    # agrega min/max/mean/std en numéricas

        schema_inspection:
          enabled: true
          methods:
            dtype_analysis:
              enabled: true
            cardinality_count:
              enabled: true
              params:
                max_unique_to_report: 50     # para no explotar tablas enormes
            null_count:
              enabled: true

    # 2.3 Verificare la qualità dei dati (Data quality assessment) — detecta, NO corrige
    step_2_3_data_quality_assessment:
      enabled: true
      technique: "data_quality_assessment"
      methods:

        missing_analysis:
          enabled: true
          params:
            show_top_columns: 30

        outlier_detection:
          enabled: true
          params:
            method: "iqr"             # iqr | zscore
            iqr_k: 1.5                # usado si method=iqr
            zscore_threshold: 3.0     # usado si method=zscore
            numeric_only: true
            max_columns: 30

        duplicate_detection:
          enabled: true
          params:
            subset: null              # null = todas las columnas
            keep: "first"

        range_validation:
          enabled: true
          params:
            rules_file: "configs/rules/ranges_quality_rules_config.yml"
            on_fail: "report_only"    # report_only (Fase2 no corrige)

        inconsistency_checks:
          enabled: true
          params:
            rules_file: "configs/rules/logic_quality_rules_config.yml"
            on_fail: "report_only"

    # 2.4 Esplorare i dati (EDA)
    step_2_4_eda:
      enabled: true
      technique: "eda"
      methods:

        histograms:
          enabled: true
          params:
            numeric_only: true
            max_columns: 20
            bins: 30

        boxplots:
          enabled: true
          params:
            numeric_only: true
            max_columns: 20

        scatter_matrix:
          enabled: true
          params:
            numeric_only: true
            max_columns: 8            # scatter-matrix explota si hay muchas
            sample_rows: 10000

        correlation_matrix:
          enabled: true
          params:
            method: "pearson"         # pearson/spearman
            numeric_only: true
            max_columns: 30

        pca_exploratory:
          enabled: true
          params:
            numeric_only: true
            n_components: 2
            sample_rows: 20000


stage3_preparation:
  objective: "Preparar datos para regresión (target continuo). Limpieza + encoding + split. Genera artefactos."

  output_policy:
    save_all_as_png: true
    figures_dir: "figures/stage3"
    tables_png_dir: "tables_png/stage3"

  steps:

    step_3_1_data_selection:
      enabled: true
      techniques:
        dataset_definition:
          enabled: true
          methods:
            manual_include_exclude: { enabled: true, params: { include: [], exclude: [] } }
            drop_technical_columns: { enabled: true, params: { patterns: ["id", "uuid", "log"] } }
            time_window_selection:  { enabled: true, params: { time_col: "${time_col}", start: null, end: null } }
            population_filtering:   { enabled: true, params: { rules_file: "configs/rules/logic_quality_rules_config.yml" } }

        feature_selection:
          enabled: true
          methods:
            semantic_based_selection: { enabled: true, params: { keep: [] } }
            business_rule_filtering:  { enabled: true, params: { rules_file: "configs/rules/logic_quality_rules_config.yml" } }
            remove_constant_features: { enabled: true, params: { threshold_unique: 1 } }
            remove_duplicate_features: { enabled: true, params: { strategy: "exact" } }

    step_3_2_data_cleaning:
      enabled: true
      techniques:
        missing_data_handling:
          enabled: true
          methods:
            mean_imputation:   { enabled: true, params: { numeric_only: true } }
            median_imputation: { enabled: true, params: { numeric_only: true } }
            mode_imputation:   { enabled: true, params: { for_categoricals: true } }
            knn_imputation:    { enabled: false, params: { n_neighbors: 5 } }
            mice_imputation:   { enabled: true,  params: {} }       # "se puede aplicar"

        outlier_handling:
          enabled: true
          methods:
            winsorization:    { enabled: false, params: { limits: [0.01, 0.01] } }
            iqr_clipping:     { enabled: true,  params: { k: 1.5 } }
            zscore_filtering: { enabled: true,  params: { threshold: 3.0 } }

        robust_transformations:
          enabled: true
          methods:
            log_transform: { enabled: true, params: { shift_if_needed: true } }
            box_cox:       { enabled: true, params: {} }
            yeo_johnson:   { enabled: true, params: {} }

        categorical_noise:
          enabled: true
          methods:
            fix_typos:          { enabled: true, params: { lowercase: true, regex_cleanup: true } }
            text_normalization: { enabled: true, params: { remove_accents: true } }
            rare_grouping:      { enabled: true, params: { min_freq: 0.01 } }

        duplicate_handling:
          enabled: true
          methods:
            exact_duplicates: { enabled: true, params: { subset: null, keep: "first" } }

        data_reduction:
          enabled: true
          methods:
            drop_rows_threshold:    { enabled: false, params: { max_na_ratio: 0.5 } }
            drop_columns_threshold: { enabled: false, params: { max_na_ratio: 0.5 } }

    step_3_3_data_transformation:
      enabled: true
      techniques:

        feature_scaling:
          enabled: true
          methods:
            standard_scaling: { enabled: true, params: {} }
            minmax_scaling:   { enabled: true, params: { feature_range: [0, 1] } }
            robust_scaling:   { enabled: true, params: {} }
            maxabs_scaling:   { enabled: true, params: {} }

        encoding:
          enabled: true
          methods:
            one_hot_encoding:   { enabled: true,  params: { handle_unknown: "ignore" } }
            ordinal_encoding:   { enabled: false, params: {} }
            target_encoding:    { enabled: false, params: {} }
            frequency_encoding: { enabled: true,  params: { min_freq: 1 } }

        feature_engineering:
          enabled: true
          methods:
            ratios:              { enabled: true, params: { definitions: [] } }
            aggregations:        { enabled: true, params: { groupby_cols: [], agg_map: {} } }
            interactions:        { enabled: true, params: {} }
            polynomial_features: { enabled: true, params: { degree: 2 } }

        temporal_features:
          enabled: false
          methods: {}

    step_3_4_data_integration:
      enabled: true
      technique: "data_integration"
      methods:
        dataset_merging: { enabled: false, params: { how: "inner", on: [] } }
        union_concat:    { enabled: false, params: { axis: 0 } }
        feature_alignment:
          enabled: true
          params: { column_renaming: {}, datatype_harmonization: true, column_selection: [] }
        data_enrichment: { enabled: false, params: { lookup_tables: [] } }

    step_3_5_data_formatting:
      enabled: true
      techniques:
        data_split:
          enabled: true
          methods:
            holdout:
              enabled: true
              params: { test_size: 0.2, random_state: 42 }
            train_val_test:
              enabled: false
              params: { train: 0.7, val: 0.1, test: 0.2, random_state: 42 }

        dataset_formatting:
          enabled: true
          methods:
            x_y_separation: { enabled: true, params: { target_col: "${target_col}" } }
            type_casting:   { enabled: true, params: {} }
            array_conversion: { enabled: true, params: { to_numpy: true } }
            sparse_dense_format: { enabled: true, params: { format: "sparse" } }
